const data = {
  "id": "141927855594505",
  "name": "Faro Chan",
  "email": "yolosteam5825@gmail.com",
  "birthday": "07/31/1998",
  "age_range": {
    "min": 21
  },
  "gender": "male",
  "hometown": {
    "id": "103707996335176",
    "name": "Swat, Pakistan"
  },
  "link": "https://www.facebook.com/app_scoped_user_id/YXNpZADpBWEVTdVBGVXJwRGRJcjJtV2FtM1JyLXBtNmtmQmRNZA0NrZAnpIZA2VvRFNPekRQcVdybUtyRnRUMG9xZATRFNkFFcVF3anJWUV9PYUJiTGtvb3NIV3lFa3dsRmM0TXg5MzhPcWQ3WnpXdFFzYkhpTVZAo/",
  "likes": {
    "data": [
      {
        "name": "Pakistan Cricket Team",
        "id": "150056741734333",
        "created_time": "2023-09-14T20:02:50+0000"
      },
      {
        "name": "NowThis",
        "id": "341163402640457",
        "created_time": "2023-09-13T19:47:16+0000"
      },
      {
        "name": "Politics Today",
        "id": "525120394533916",
        "created_time": "2023-09-13T19:47:14+0000"
      },
      {
        "name": "Fox News Politics",
        "id": "144868455552699",
        "created_time": "2023-09-13T19:47:09+0000"
      },
      {
        "name": "CNN Politics",
        "id": "219367258105115",
        "created_time": "2023-09-13T19:47:07+0000"
      },
      {
        "name": "Politics Today",
        "id": "106895022095315",
        "created_time": "2023-09-13T19:47:06+0000"
      },
      {
        "name": "ABC News Politics",
        "id": "184096565021911",
        "created_time": "2023-09-13T19:47:01+0000"
      },
      {
        "name": "World News Now",
        "id": "55845270277",
        "created_time": "2023-09-13T19:46:58+0000"
      },
      {
        "name": "NowThis Politics",
        "id": "908009612563863",
        "created_time": "2023-09-13T19:46:54+0000"
      },
      {
        "name": "Arsalan Naseer - CBA",
        "id": "189595927759501",
        "created_time": "2023-09-13T19:44:30+0000"
      },
      {
        "name": "Momin Saqib",
        "id": "843576009075387",
        "created_time": "2023-09-13T19:44:21+0000"
      },
      {
        "name": "Shahid Afridi",
        "id": "671486682914093",
        "created_time": "2023-09-13T19:44:11+0000"
      },
      {
        "name": "Wasim Akram",
        "id": "151429844900482",
        "created_time": "2023-09-13T19:43:59+0000"
      },
      {
        "name": "Virat Kohli",
        "id": "326546224099154",
        "created_time": "2023-09-13T19:43:28+0000"
      },
      {
        "name": "Babar Azam",
        "id": "431142466953761",
        "created_time": "2023-09-13T19:43:11+0000"
      },
      {
        "name": "Rooms, Houses, Flats for rent in Manchester UK",
        "id": "104577692470903",
        "created_time": "2023-09-13T19:42:40+0000"
      },
      {
        "name": "Manchester Homes",
        "id": "103953221840810",
        "created_time": "2023-09-13T19:42:30+0000"
      },
      {
        "name": "Manchester Student Homes",
        "id": "121363211279864",
        "created_time": "2023-09-13T19:42:28+0000"
      },
      {
        "name": "Rent  Manchester - WeRentUk",
        "id": "219792571784730",
        "created_time": "2023-09-13T19:42:25+0000"
      },
      {
        "name": "Amazon.com",
        "id": "9465008123",
        "created_time": "2023-09-13T19:41:07+0000"
      },
      {
        "name": "Amazon Web Services",
        "id": "153063591397681",
        "created_time": "2023-09-13T19:41:01+0000"
      },
      {
        "name": "Cybersecurity and Infrastructure Security Agency",
        "id": "110903187120988",
        "created_time": "2023-09-13T19:38:27+0000"
      },
      {
        "name": "The Job Gym",
        "id": "156499011156633",
        "created_time": "2023-09-13T19:38:10+0000"
      },
      {
        "name": "Jobs in Manchester",
        "id": "102641472834894",
        "created_time": "2023-09-13T19:37:52+0000"
      },
      {
        "name": "Government of Pakistan",
        "id": "149439858472433",
        "created_time": "2023-09-13T19:37:21+0000"
      }
    ],
    "paging": {
      "cursors": {
        "before": "MTUwMDU2NzQxNzM0MzMz",
        "after": "MTQ5NDM5ODU4NDcyNDMz"
      },
      "next": "https://graph.facebook.com/v17.0/141927855594505/likes?access_token=EAAL2YnoZCn20BOxGipmLSxNdr8FX589rG9IQUPBKPZCV7G5Yxby2mHgdlUSBrEt6BsGnkYB4DXpwvB0IGmmmmZCxttTPn29YNuxxfaJ4Ye8LePuWxPURea1HJTH6BJLnJgyFpZC5MCWxoBX1OlCHZBdEh28ddMxjVcluWKyQwh3JvapULDmDuczwT68ZClmgy4d8jp5xF35LPABS6bwRvlKHwkiiXvcR812OLYSMH0zHafVhZCqa7BM&limit=25&after=MTQ5NDM5ODU4NDcyNDMz"
    }
  },
  "groups": {
    "data": [
      {
        "name": "Cyber Security Jobs",
        "id": "1042378370061476"
      },
      {
        "name": "Manchester Job Opportunities",
        "id": "1479222995445334"
      },
      {
        "name": "Legends are OP",
        "privacy": "OPEN",
        "id": "346407324388196"
      },
      {
        "name": "We Don't Like Cricket We Love It",
        "id": "187356471811600"
      },
      {
        "name": "POLITICS  OF PAKISTAN \u067E\u0627\u06A9\u0633\u062A\u0627\u0646 \u06A9\u06CC \u0633\u06CC\u0627\u0633\u062A",
        "id": "307824573002255"
      },
      {
        "name": "Cricket: Verbal Warfare",
        "id": "370424303610423"
      },
      {
        "name": "International Affairs, History and Politics",
        "id": "1394015497543964"
      },
      {
        "name": "Pakistan Political Posting Area",
        "id": "804437930113015"
      },
      {
        "name": "Pakistan Political Memes",
        "id": "618013033484852"
      },
      {
        "name": "ICC Cricket World Cup 2023",
        "id": "731748451704417"
      },
      {
        "name": "Cricket Fever For Cricket Lovers",
        "id": "3171155852907473"
      },
      {
        "name": "Cricket Experts",
        "id": "1715506112096939"
      },
      {
        "name": "Cricket Media",
        "id": "3181704418824158"
      },
      {
        "name": "Apartments & Houses For Sale & To Rent In Manchester City Centre",
        "id": "412829348764214"
      },
      {
        "name": "Rooms, Houses, Flats for Rent in MANCHESTER, UK",
        "id": "538703739642815"
      },
      {
        "name": "Swansea University",
        "id": "2211085460"
      },
      {
        "name": "AMAZON WEB SERVICES (AWS)",
        "id": "518118609062012"
      },
      {
        "name": "Cyber Security & Cyber Attacks (Esoft HND PP-G2)",
        "id": "1051039975497897"
      },
      {
        "name": "Cyber Awareness",
        "id": "189309787776559"
      },
      {
        "name": "Cyber security for Beginners",
        "id": "520954975287331"
      },
      {
        "name": "Cyber Security Courses Free",
        "id": "776769720420938"
      },
      {
        "name": "Cyber Security Education UK (FREE) Cyber Security/Computer Science Course",
        "id": "815709366089430"
      },
      {
        "name": "Jobs in Manchester",
        "id": "205871985609033"
      },
      {
        "name": "POETIC",
        "id": "237787817577123"
      },
      {
        "name": "Writers and Poetic People",
        "id": "1933439023334177"
      }
    ],
    "paging": {
      "cursors": {
        "before": "QVFIUlVacHgzYVBGLTh5ZAmNUVmxkN1lxRTZAaWS1pRWtZAMWQ3b2hQN3M1b2YwNXN2SFVRek9ycHBBOERRQWtqdER0VjQ1NTdiTTlIT0x1SW54ek5jQmowb2RR",
        "after": "QVFIUlpxNm4wamZASQ0hQTjFMTEdRY2VTdl9kR2NhNlk4bFp0NDlaTFhvNjFCUTdGYXpETjRnd3BLVmI4U08zYTZACSGF6NUVVQlNOUmNTbklXRGRwTWItU2hB"
      },
      "next": "https://graph.facebook.com/v17.0/141927855594505/groups?access_token=EAAL2YnoZCn20BOxGipmLSxNdr8FX589rG9IQUPBKPZCV7G5Yxby2mHgdlUSBrEt6BsGnkYB4DXpwvB0IGmmmmZCxttTPn29YNuxxfaJ4Ye8LePuWxPURea1HJTH6BJLnJgyFpZC5MCWxoBX1OlCHZBdEh28ddMxjVcluWKyQwh3JvapULDmDuczwT68ZClmgy4d8jp5xF35LPABS6bwRvlKHwkiiXvcR812OLYSMH0zHafVhZCqa7BM&limit=25&after=QVFIUlpxNm4wamZASQ0hQTjFMTEdRY2VTdl9kR2NhNlk4bFp0NDlaTFhvNjFCUTdGYXpETjRnd3BLVmI4U08zYTZACSGF6NUVVQlNOUmNTbklXRGRwTWItU2hB"
    }
  },
  "picture": {
    "data": {
      "height": 50,
      "is_silhouette": false,
      "url": "https://platform-lookaside.fbsbx.com/platform/profilepic/?asid=141927855594505&height=50&width=50&ext=1697534327&hash=AeQzxR27l6ygav4iXMU",
      "width": 50
    }
  },
  "languages": [
    {
      "id": "110732602281239",
      "name": "Urdu"
    },
    {
      "id": "101895976519458",
      "name": "English"
    },
    {
      "id": "101894249852487",
      "name": "Pushto language"
    }
  ],
  "favorite_teams": [
    {
      "id": "150056741734333",
      "name": "Pakistan Cricket Team"
    },
    {
      "id": "19390830193",
      "name": "England Cricket"
    }
  ],
  "favorite_athletes": [
    {
      "id": "671486682914093",
      "name": "Shahid Afridi"
    },
    {
      "id": "151429844900482",
      "name": "Wasim Akram"
    },
    {
      "id": "326546224099154",
      "name": "Virat Kohli"
    },
    {
      "id": "431142466953761",
      "name": "Babar Azam"
    }
  ],
  "businesses": {
    "data": [
      {
        "id": "991527245449405",
        "name": "Swat Capital Resort"
      },
      {
        "id": "300330605880688",
        "name": "Farhan Productions"
      }
    ],
    "paging": {
      "cursors": {
        "before": "QVFIUjZAKaVNVZAUt2T3JBUEwyY3R4RmxKb0VNLTZAPMlF5UnUzZAWl1alpiWTZAzVTEwWFJWQUtMMjZACS2FqV3FtbmdHTE5lYTh0MHdRd2lucTRXSm53bzNzeGNn",
        "after": "QVFIUmZAVVW9BREI4RXBjekVrVTFUcmVEVWN5QTl1NmR3ekJ6cUN4X3h2N3VaTlVOX0RMWm9HNEJLejRpTlBDWkJMZA1hBM21NcTZAZATWpYTWpDM2F3OU56cFFB"
      }
    }
  }
}

const fs = require('fs');
const csv = require('csv-parser');
const { createObjectCsvWriter } = require('csv-writer');
const csvFilePath = './extras/Book1.csv';

// Reading the Data set
function readCsvData() {
  return new Promise((resolve, reject) => {
    const data = [];

    fs.createReadStream(csvFilePath)
      .pipe(csv())
      .on('data', (row) => {
        data.push(row);
      })
      .on('end', () => {
        resolve(data);
      })
      .on('error', (error) => {
        reject(error);
      });
    return data
  });
}


// Writing to an existing Data set
async function writeCsvData(apiData, csvFilePath, Language, Religion, LivesIn, Result) {
  const modifiedData = [
    {
      Hometown: apiData.hometown.name,
      Language,
      Religion,
      LivesIn,
      Result,
    }
  ];
  // Read the existing CSV data
  const csvData = await readCsvData(csvFilePath);
  // Combine the existing data with the modified data
  const combinedData = [...csvData, ...modifiedData];
  // Create a CSV writer with append set to false to overwrite the file
  const csvWriter = createObjectCsvWriter({
    path: csvFilePath,
    header: [
      { id: 'Hometown', title: 'Hometown' },
      { id: 'Language', title: 'Language' },
      { id: 'Religion', title: 'Religion' },
      { id: 'LivesIn', title: 'LivesIn' },
      { id: 'Result', title: 'Result' },
    ],
    append: false,
  });

  await csvWriter.writeRecords(combinedData);
}

// Reading ths Csv File and returning the results
// async function readCsvFile(apiData, csvFilePath, location) {
//   const csvData = await readCsvData(csvFilePath);
//   const jsonData = JSON.stringify(apiData);
//   const parsedData = JSON.parse(jsonData);
//   const foundResults = []
//   const exactMatch = []
//   csvData.map(({ Hometown, Language, LivesIn }, i) => {
//     const parsedHometown = parsedData.hometown.name.replace(/\s/g, '').toLowerCase();
//     const dataHometown = Hometown.replace(/\s/g, '').toLowerCase();
//     const parsedLanguage = parsedData.languages.map((l) => l.name.split(' ')[0]);
//     if (parsedHometown === dataHometown || parsedLanguage.includes(Language)) {
//       foundResults.push(csvData[i]);
//       if (parsedHometown === dataHometown && parsedLanguage.includes(Language)) {
//         exactMatch.push(csvData[i]);
//       }
//     }
//   })
//   return { foundResults, exactMatch }
// }

async function readCsvFile(apiData, csvFilePath, location) {
  const csvData = await readCsvData(csvFilePath);
  const { hometown, languages } = apiData;
  const parsedHometown = hometown.name.replace(/\s/g, '').toLowerCase();
  const parsedLanguages = languages.map((l) => l.name.split(' ')[0]);

  const foundResults = [];
  const exactMatch = [];

  csvData.forEach((row) => {
    const { Hometown, Language, LivesIn } = row;
    const dataHometown = Hometown.replace(/\s/g, '').toLowerCase();

    if (
      parsedHometown === dataHometown ||
      parsedLanguages.includes(Language) ||
      LivesIn === location
    ) {
      foundResults.push(row);

      if (
        parsedHometown === dataHometown &&
        parsedLanguages.includes(Language) &&
        LivesIn === location
      ) {
        exactMatch.push(row);
      }
    }
  });

  return { foundResults, exactMatch };
}

module.exports = { writeCsvData, readCsvFile, readCsvData };
